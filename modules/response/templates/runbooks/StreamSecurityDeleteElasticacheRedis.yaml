schemaVersion: '0.3'
description: |
  This runbook deletes a specific ElastiCache Redis CacheCluster by its ID.
  It ignores any replication group association and deletes the cluster directly.
  After 20 seconds, it verifies that the cluster has been deleted.
assumeRole: '{{ AutomationAssumeRole }}'
parameters:
  AutomationAssumeRole:
    type: String
    description: (Optional) IAM Role ARN to perform the automation.
    default: ''
  ClusterId:
    type: String
    description: (Required) The ElastiCache Redis cluster ID to delete.
  Region:
    type: String
    description: (Required) The AWS region where the Redis cluster exists.
mainSteps:
  - name: DeleteRedisCacheCluster
    action: aws:executeScript
    nextStep: VerifyRedisDeletion
    isEnd: false
    inputs:
      Runtime: python3.11
      Handler: main
      InputPayload:
        ClusterId: '{{ ClusterId }}'
        Region: '{{ Region }}'
      Script: |
        import boto3
        from botocore.exceptions import ClientError, WaiterError

        def main(events, context):
            region = events['Region']
            cluster_id = events['ClusterId']
            client = boto3.client('elasticache', region_name=region)

            try:
                response = client.describe_cache_clusters(
                    CacheClusterId=cluster_id,
                    ShowCacheNodeInfo=False
                )
                cluster = response['CacheClusters'][0]
                status = cluster.get('CacheClusterStatus')
                print(f"Current status of cluster '{cluster_id}': {status}")

                if status.lower() in ["creating", "rebooting cache cluster nodes", "modifying", "snapshotting"]:
                    print(f"Cluster '{cluster_id}' is in status {status}. Waiting until it becomes 'available'...")
                    waiter = client.get_waiter('cache_cluster_available')
                    try:
                        waiter.wait(
                            CacheClusterId=cluster_id,
                            WaiterConfig={
                                'Delay': 15,          # seconds between attempts
                                'MaxAttempts': 60     # total wait time: 15*60=900 seconds (15 minutes)
                            }
                        )
                        print(f"Cluster '{cluster_id}' is now available.")
                    except WaiterError as we:
                        raise Exception(f"Cluster '{cluster_id}' did not reach 'available' state in time: {we}")
                else:
                    if status != "available":
                        raise Exception(f"Cluster '{cluster_id}' is not in 'available' state (status: {status}).")
                
                print(f"Deleting cache cluster '{cluster_id}'...")
                client.delete_cache_cluster(CacheClusterId=cluster_id)
                return {
                    "Message": f"Cache cluster '{cluster_id}' deletion initiated.",
                    "ClusterId": cluster_id
                }

            except ClientError as e:
                if "NotFound" in str(e):
                    print(f"Cluster '{cluster_id}' not found. Nothing to delete.")
                    return {
                        "Message": f"Cluster '{cluster_id}' not found.",
                        "Exists": False
                    }
                raise
    outputs:
      - Name: ClusterId
        Selector: $.Payload.ClusterId
        Type: String

  - name: VerifyRedisDeletion
    action: aws:executeScript
    isEnd: true
    inputs:
      Runtime: python3.11
      Handler: main
      InputPayload:
        ClusterId: '{{ DeleteRedisCacheCluster.ClusterId }}'
        Region: '{{ Region }}'
      Script: |
        import boto3
        from botocore.exceptions import ClientError
        import time

        def main(events, context):
            region = events['Region']
            cluster_id = events['ClusterId']
            client = boto3.client('elasticache', region_name=region)

            print(f"Waiting 20 seconds before verifying deletion of cluster '{cluster_id}'...")
            time.sleep(20)

            try:
                response = client.describe_cache_clusters(CacheClusterId=cluster_id)
                status = response['CacheClusters'][0].get('CacheClusterStatus', 'unknown')
                print(f"Cluster still exists with status: {status}")
                if status.lower() == "deleting":
                    return {"Verification": "InProgress"}
                else:
                    raise Exception(f"Cluster '{cluster_id}' still exists with status: {status}")
            except ClientError as e:
                if "NotFound" in str(e):
                    print(f"Cluster '{cluster_id}' successfully deleted.")
                    return {"Verification": "Success"}
                raise
